!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t():"function"==typeof define&&define.amd?define(t):t()}(0,function(){"use strict";var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},t=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},n=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),r=function(){function e(){t(this,e)}return n(e,null,[{key:"createGuid",value:function(){var e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?n:3&n|8).toString(16)})}},{key:"createRandWithin",value:function(e,t){return Math.random()*(t-e)+e}}]),e}(),i=function(){function e(){t(this,e)}return n(e,null,[{key:"get",value:function(e){var t=document.cookie.match(new RegExp(e+"=([^;]+)"));return!0===(t&&(t=JSON.parse(JSON.stringify(t[1]))))?null:t}},{key:"set",value:function(e){var t=e;document.cookie=t.name+"="+t.data+";"+t.expiry+";domain=.allrecipes.com;path=/"}},{key:"cookie",value:function(e,t){var n={};if(n.name=e,n.data=r.createGuid(),t){var i=new Date;i.setTime(i.getTime()+60*t*1e3);var o="expires="+i.toGMTString();n.expiry=o}return n}},{key:"createIfNotExists",value:function(t){if(t&&t.name){e.get(t.name)||e.set(t)}}}]),e}(),o=function(){function e(){t(this,e)}return n(e,null,[{key:"setPageViewCookie",value:function(){var e=i.cookie("telemetryPageviewId");this.PageViewId=e.data,i.set(e)}},{key:"setUserCookie",value:function(){var e=i.cookie("telemetryUserId",52034400);i.createIfNotExists(e)}}]),e}(),u=function(){function e(){t(this,e)}return n(e,null,[{key:"impressionAttribute",get:function(){return"data-scoby-impression"}},{key:"clickAttribute",get:function(){return"data-scoby-click"}},{key:"defaultHostName",get:function(){return"Monetization"}}]),e}(),a=function(){function e(){t(this,e)}return n(e,null,[{key:"getHostName",value:function(){return window.location.hostname}},{key:"getCurrentUrl",value:function(){return window.location.href}},{key:"getSecondLevelDomain",value:function(){var e=u.defaultHostName,t=this.getHostName();if(!t)return e;var n=t.split(".").reverse();return!n||n.length<2?e:n[1].charAt(0).toUpperCase()+n[1].slice(1)}},{key:"getEndPoint",value:function(){var e=this.getCurrentUrl();if(e){var t=e.split("allrecipes.com");if(t&&t.length>0)return t[0].indexOf(".corp")>-1||t[0].indexOf("test")>-1||t[0].indexOf("arci")>-1||t[0].indexOf("arssl")>-1||t[0].indexOf("arpreprod")>-1?"https://telemetry.test.allrecipes.com/api/v1/events":t[0].indexOf("localhost")>-1?"http://localhost:23022/api/v1/events":"https://telemetry.allrecipes.com/api/v1/events"}return""}},{key:"getCdnEndPoint",value:function(){var e=this.getCurrentUrl();if(e){var t=e.split("allrecipes.com");return t&&t.length>0?t[0].indexOf(".corp")>-1||t[0].indexOf("test")>-1?"https://motest-cdnservice-uw1.azureedge.net/telemetryapi/1/showads.js":t[0].indexOf("localhost")>-1?"http://localhost:8080/1/showads.js":"https://moprd-cdnservice-uw1.azureedge.net/telemetryapi/1/showads.js":""}return""}}]),e}(),s=function(){function e(){t(this,e)}return n(e,null,[{key:"postAsync",value:function(e){return new Promise(function(t,n){var r=new XMLHttpRequest;r.withCredentials="true",r.open("POST",a.getEndPoint()),r.setRequestHeader("Content-Type","application/json; charset=utf-8"),r.onload=function(){200===r.status?t(r.response):n({status:r.status,statusText:r.statusText})},r.onerror=function(){n({status:r.status,statusText:r.statusText})},r.send(JSON.stringify(e))})}}]),e}(),c=function(){function e(){t(this,e)}return n(e,null,[{key:"promisifiedWait",value:function(e){return new Promise(function(t){return setTimeout(t,e||500)})}},{key:"promisifiedRetry",value:function(e,t,n){var i=this;return t().catch(function(o){return!o||0!==o.status&&500!==o.status?Promise.reject("Telemetry API returned an error.\n              Error status - "+o.status+" and status text - "+o.statusText):e>0?i.promisifiedWait(2*n+r.createRandWithin(.1,.11)).then(function(){return i.promisifiedRetry(e-1,t,n+r.createRandWithin(.1,.11))}):Promise.reject("Retries to hit telemetry API failed  with\n              status - "+o.status+" and status text - "+o.statusText)})}}]),e}(),l=function(){function e(){t(this,e)}return n(e,null,[{key:"LogAndThrow",value:function(e){throw console.log("ARMON: "+e),new TypeError("ARMON: "+e)}},{key:"LogErrorToConsole",value:function(e){console.error("ARMON: "+e)}}]),e}(),f=function(){function e(){t(this,e)}return n(e,null,[{key:"postTelemetryData",value:function(e){c.promisifiedRetry(5,s.postAsync.bind(null,e),50).catch(function(e){return l.LogErrorToConsole(e)})}}]),e}(),d=function e(n,r){t(this,e),this.Message="Error thrown at "+n+", error is "+r},y=function(){function r(){t(this,r)}return n(r,null,[{key:"ThrowAndLogIfNotAnObject",value:function(t){if("object"!==(void 0===t?"undefined":e(t))){var n=new d("validation","value is not an object");l.LogAndThrow(n.Message)}}},{key:"ThrowAndLogIfNullOrUndefined",value:function(e){if("undefined"===e||null===e){var t=new d("validation","value cannot be null or undefined");l.LogAndThrow(t.Message)}}}]),r}(),v=function e(n,r,i,o,u){t(this,e),y.ThrowAndLogIfNullOrUndefined(r),this.id=n,this.eventType=r,this.eventCategory=void 0===i?null:i,this.eventParentId=o,u&&(y.ThrowAndLogIfNotAnObject(u),this.value=JSON.stringify(u))},m=function(){function e(){t(this,e)}return n(e,null,[{key:"createScriptElement",value:function(e){var t=document.createElement("script");return t.id=e,t}},{key:"createImageElement",value:function(e){var t=document.createElement("img");return t.id=e,t}},{key:"findElementById",value:function(e){return e?document.getElementById(e):null}},{key:"appendScript",value:function(e){var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}},{key:"appendElement",value:function(e){document.body.appendChild(e)}},{key:"findAllElemenstByContext",value:function(e,t){return e&&t?Array.prototype.slice.call(e.querySelectorAll(t)):[]}},{key:"findFirstElementByContext",value:function(e,t){return e&&t?e.querySelector(t):null}},{key:"readAttributeValue",value:function(e,t){return e&&t?e.getAttribute(t):null}}]),e}(),p=function(){function e(){t(this,e)}return n(e,null,[{key:"findImpressionableElementsAndFetchData",value:function(e){return m.findAllElemenstByContext(e,"["+u.impressionAttribute+"]").filter(function(e){return null!==e}).map(function(e){return m.readAttributeValue(e,""+u.impressionAttribute)})}},{key:"findClickableElements",value:function(e){return m.findAllElemenstByContext(e,"["+u.clickAttribute+"]").filter(function(e){return null!==e})}}]),e}(),h=void 0;h=!1;var g=function(e){h||"complete"===document.readyState&&(h=!0,e.map(function(e){return e()}))},x=function(e){h||(h=!0,e.map(function(e){return e()}))},k=function(){function e(){t(this,e)}return n(e,null,[{key:"fire",value:function(e){document.addEventListener?(document.addEventListener("DOMContentLoaded",x(e),!1),document.addEventListener("readystatechange",g(e),!1),window.addEventListener("load",x(e),!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",g(e)),window.attachEvent("onload",x(e)))}}]),e}(),w=function(){function r(){t(this,r)}return n(r,null,[{key:"scrub",value:function(t){if(t&&t.length){return t.map(function(t){try{var n=void 0;if(null===t)return null;if("string"==typeof t)try{n=JSON.parse(t)}catch(e){var r=void 0;r=t.replace(/'/g,'"'),r=r.replace(/\\"/g,"'"),n=JSON.parse(r)}else"object"===(void 0===t?"undefined":e(t))&&(n=t);return new v(n.id,n.eventType,n.eventCategory,n.eventParentId,n.value)}catch(e){return l.LogAndThrow(e),null}}).filter(function(e){return null!==e})}return[]}},{key:"send",value:function(e){e&&this.scrub(e).filter(function(e){return null!==e}).map(f.postTelemetryData)}},{key:"start",value:function(e){var t=this,n=[],r=function(){var n=p.findImpressionableElementsAndFetchData(e);t.send(n)},i=function(){var n=function(e,n){n.addEventListener("click",function(){t.send([e])},!1)};p.findClickableElements(e).map(function(e){return n(m.readAttributeValue(e,u.clickAttribute),e)})};n.push(r),n.push(i),k.fire(n)}}]),r}(),b=function e(n){t(this,e),o.setPageViewCookie(),o.setUserCookie(),w.start(n),this.send=function(e){var t=[e];w.send(t)}};!function(e){var t=e,n=document;t.telemetry=new b(n)}(window.scoby=window.scoby||{})});
//# sourceMappingURL=telemetry.js.map
